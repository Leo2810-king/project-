<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîëC√¥ng C·ª• M√£ H√≥a RSA - An To√†n M·∫°ng</title>
    <link rel="stylesheet" href="style1.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Hi·ªáu ·ª©ng Matrix Background -->
    <canvas class="matrix-bg" id="matrixCanvas"></canvas>

    <div class="container">
        <header class="header">
            <h1 class="title">
                <span class="bracket">[</span> H·ªÜ TH·ªêNG M√É H√ìA RSA
                <span class="bracket">]</span>
            </h1>
            <div class="subtitle">C√¥ng C·ª• M·∫≠t M√£ N√¢ng Cao v2.0</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Panel T·∫°o Kh√≥a -->
            <div class="panel key-panel">
                <div class="panel-header">
                    <h3>üîë T·∫°o C·∫∑p Kh√≥a RSA</h3>
                </div>
                <div class="panel-content">
                    <div class="input-group">
                        <label>K√≠ch th∆∞·ªõc kh√≥a (bits)</label>
                        <select id="keySize">
                            <option value="512">512 bits (Nhanh)</option>
                            <option value="1024" selected>1024 bits (Khuy·∫øn ngh·ªã)</option>
                            <option value="2048">2048 bits (An to√†n)</option>
                            <option value="4096">4096 bits (T·ªëi ƒëa)</option>
                        </select>
                    </div>

                    <div class="security-warning">
                        Kh√≥a l·ªõn h∆°n = B·∫£o m·∫≠t cao h∆°n nh∆∞ng ch·∫≠m h∆°n
                    </div>

                    <button class="btn btn-primary" onclick="taoKhoa()">
                        <span id="keyGenText">T·∫°o Kh√≥a RSA</span>
                        <span id="keyGenLoading" class="loading" style="display: none;"></span>
                    </button>

                    <div class="keys-display">
                        <div class="key-box">
                            <h4>üîì Kh√≥a C√¥ng Khai (n, e)
                                <span class="tooltip" data-tooltip="D√πng ƒë·ªÉ m√£ h√≥a d·ªØ li·ªáu - C√≥ th·ªÉ chia s·∫ª">‚ÑπÔ∏è</span>
                            </h4>
                            <div class="key-output" id="publicKey">Kh√≥a s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</div>
                            <button class="btn btn-success" onclick="saoChep('publicKey')" style="margin-top: 10px; padding: 8px 16px; font-size: 0.8rem;">
                                Sao Ch√©p Kh√≥a C√¥ng Khai
                            </button>
                        </div>
                        <div class="key-box">
                            <h4>üîí Kh√≥a B√≠ M·∫≠t (n, d)
                                <span class="tooltip" data-tooltip="D√πng ƒë·ªÉ gi·∫£i m√£ d·ªØ li·ªáu - TUY·ªÜT ƒê·ªêI B·∫¢O M·∫¨T!">‚ö†Ô∏è</span>
                            </h4>
                            <div class="key-output" id="privateKey">Kh√≥a s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</div>
                            <button class="btn btn-danger" onclick="saoChep('privateKey')" style="margin-top: 10px; padding: 8px 16px; font-size: 0.8rem;">
                                Sao Ch√©p Kh√≥a B√≠ M·∫≠t
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel M√£ H√≥a -->
            <div class="panel encrypt-panel">
                <div class="panel-header">
                    <h3>üîí Qu√° Tr√¨nh M√£ H√≥a</h3>
                </div>
                <div class="panel-content">
                    <div class="input-group">
                        <label>Tin nh·∫Øn c·∫ßn m√£ h√≥a</label>
                        <textarea id="plaintext" placeholder="Nh·∫≠p tin nh·∫Øn b√≠ m·∫≠t c·ªßa b·∫°n...&#10;V√≠ d·ª•: Xin ch√†o th·∫ø gi·ªõi!"></textarea>
                    </div>

                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="hexOutput" style="margin-right: 8px;">
                            Xu·∫•t k·∫øt qu·∫£ d·∫°ng Hexadecimal
                        </label>
                    </div>

                    <button class="btn btn-success" onclick="maHoaTinNhan()">
                        <span id="encryptText">üîê M√£ H√≥a Tin Nh·∫Øn</span>
                        <span id="encryptLoading" class="loading" style="display: none;"></span>
                    </button>

                    <div class="output-box">
                        <h4>Tin Nh·∫Øn ƒê√£ M√£ H√≥a
                            <span class="tooltip" data-tooltip="D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c m√£ h√≥a th√†nh c√¥ng">üîê</span>
                        </h4>
                        <div class="output" id="encryptedOutput">D·ªØ li·ªáu m√£ h√≥a s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</div>
                        <button class="btn btn-primary" onclick="saoChep('encryptedOutput')" style="margin-top: 10px; padding: 8px 16px; font-size: 0.8rem;">
                            Sao Ch√©p D·ªØ Li·ªáu M√£ H√≥a
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel Gi·∫£i M√£ -->
            <div class="panel decrypt-panel">
                <div class="panel-header">
                    <h3>üîì Qu√° Tr√¨nh Gi·∫£i M√£</h3>
                </div>
                <div class="panel-content">
                    <div class="input-group">
                        <label>Tin nh·∫Øn ƒë√£ m√£ h√≥a</label>
                        <textarea id="ciphertext" placeholder="D√°n tin nh·∫Øn ƒë√£ m√£ h√≥a v√†o ƒë√¢y...&#10;ƒê·ªãnh d·∫°ng: 123,456,789..."></textarea>
                    </div>

                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="hexInput" style="margin-right: 8px;">
                            D·ªØ li·ªáu nh·∫≠p v√†o d·∫°ng Hexadecimal
                        </label>
                    </div>

                    <button class="btn btn-warning" onclick="giaiMaTinNhan()">
                        <span id="decryptText">üîì Gi·∫£i M√£ Tin Nh·∫Øn</span>
                        <span id="decryptLoading" class="loading" style="display: none;"></span>
                    </button>

                    <div class="output-box">
                        <h4>Tin Nh·∫Øn ƒê√£ Gi·∫£i M√£
                            <span class="tooltip" data-tooltip="VƒÉn b·∫£n g·ªëc ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c">üìù</span>
                        </h4>
                        <div class="output" id="decryptedOutput">D·ªØ li·ªáu gi·∫£i m√£ s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</div>
                        <button class="btn btn-success" onclick="saoChep('decryptedOutput')" style="margin-top: 10px; padding: 8px 16px; font-size: 0.8rem;">
                            Sao Ch√©p VƒÉn B·∫£n G·ªëc
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel Th√¥ng Tin Thu·∫≠t To√°n -->
            <div class="panel info-panel">
                <div class="panel-header">
                    <h3>üìä Chi Ti·∫øt Thu·∫≠t To√°n RSA</h3>
                </div>
                <div class="panel-content">
                    <div class="info-item">
                        <strong>üîç C√°c B∆∞·ªõc Thu·∫≠t To√°n:</strong>
                        <ol>
                            <li><strong>T·∫°o s·ªë nguy√™n t·ªë:</strong> Ch·ªçn 2 s·ªë nguy√™n t·ªë l·ªõn p v√† q</li>
                            <li><strong>T√≠nh n:</strong> n = p √ó q (modulus)</li>
                            <li><strong>T√≠nh œÜ(n):</strong> œÜ(n) = (p-1) √ó (q-1)</li>
                            <li><strong>Ch·ªçn e:</strong> Ch·ªçn e nguy√™n t·ªë c√πng nhau v·ªõi œÜ(n), th∆∞·ªùng l√† 65537</li>
                            <li><strong>T√≠nh d:</strong> d ‚â° e‚Åª¬π (mod œÜ(n))</li>
                            <li><strong>Kh√≥a C√¥ng Khai:</strong> (n, e) - C√≥ th·ªÉ chia s·∫ª</li>
                            <li><strong>Kh√≥a B√≠ M·∫≠t:</strong> (n, d) - Ph·∫£i gi·ªØ b√≠ m·∫≠t</li>
                        </ol>
                    </div>

                    <div class="info-item">
                        <strong>üîê C√¥ng Th·ª©c M√£ H√≥a/Gi·∫£i M√£:</strong>
                        <div class="code-block">
                            <pre>M√£ h√≥a:  C = M^e mod n
Gi·∫£i m√£:  M = C^d mod n

Trong ƒë√≥:
- M: Th√¥ng ƒëi·ªáp g·ªëc (Message)
- C: Th√¥ng ƒëi·ªáp m√£ h√≥a (Ciphertext)
- e: S·ªë m≈© c√¥ng khai (Public exponent)
- d: S·ªë m≈© b√≠ m·∫≠t (Private exponent)  
- n: Modulus (t√≠ch c·ªßa 2 s·ªë nguy√™n t·ªë)</pre>
                        </div>
                    </div>

                    <div class="status" id="status">üîÑ S·∫µn s√†ng m√£ h√≥a...</div>

                    <div class="info-item">
                        <strong>‚ö° Th·ªëng K√™ Hi·ªáu Su·∫•t:</strong>
                        <div id="performanceStats">
                            <div>Th·ªùi gian t·∫°o kh√≥a: <span id="keyGenTime">-</span>ms</div>
                            <div>Th·ªùi gian m√£ h√≥a: <span id="encryptTime">-</span>ms</div>
                            <div>Th·ªùi gian gi·∫£i m√£: <span id="decryptTime">-</span>ms</div>
                        </div>
                    </div>

                    <div class="info-item">
                        <strong>üõ°Ô∏è L∆∞u √ù B·∫£o M·∫≠t:</strong>
                        <ul style="color: #ccc; padding-left: 20px;">
                            <li>KH√îNG BAO GI·ªú chia s·∫ª kh√≥a b√≠ m·∫≠t (Private Key)</li>
                            <li>S·ª≠ d·ª•ng kh√≥a √≠t nh·∫•t 2048 bits cho m√¥i tr∆∞·ªùng th·ª±c t·∫ø</li>
                            <li>ƒê·∫£m b·∫£o m√°y t√≠nh an to√†n khi t·∫°o kh√≥a</li>
                            <li>Th∆∞·ªùng xuy√™n thay ƒë·ªïi kh√≥a ƒë·ªÉ tƒÉng b·∫£o m·∫≠t</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="terminal-line">
                <span class="prompt">root@baomat:~$</span>
                <span class="command">H·ªá th·ªëng m√£ h√≥a RSA ƒëang ho·∫°t ƒë·ªông</span>
                <span class="cursor">‚ñà</span>
            </div>
        </footer>
    </div>

    <script>
        // RSA Class ƒë∆°n gi·∫£n v√† ho·∫°t ƒë·ªông
        class MaHoaRSANangCao {
            constructor() {
                this.khoaCongKhai = null;
                this.khoaBiMat = null;
                this.thongKeHieuSuat = {
                    thoiGianTaoKhoa: 0,
                    thoiGianMaHoa: 0,
                    thoiGianGiaiMa: 0
                };
            }

            // Ki·ªÉm tra s·ªë nguy√™n t·ªë
            laSoNguyenTo(n) {
                if (n < 2) return false;
                if (n === 2) return true;
                if (n % 2 === 0) return false;

                for (let i = 3; i <= Math.sqrt(n); i += 2) {
                    if (n % i === 0) return false;
                }
                return true;
            }

            // T·∫°o s·ªë nguy√™n t·ªë ƒë∆°n gi·∫£n
            taoSoNguyenTo(min = 50, max = 200) {
                let soNguyenTo;
                do {
                    soNguyenTo = Math.floor(Math.random() * (max - min + 1)) + min;
                } while (!this.laSoNguyenTo(soNguyenTo));
                return soNguyenTo;
            }

            // GCD - ∆Ø·ªõc chung l·ªõn nh·∫•t
            ucln(a, b) {
                while (b !== 0) {
                    [a, b] = [b, a % b];
                }
                return a;
            }

            // Extended Euclidean Algorithm
            euclideanMoRong(a, b) {
                if (a === 0) return [b, 0, 1];

                const [gcd, x1, y1] = this.euclideanMoRong(b % a, a);
                const x = y1 - Math.floor(b / a) * x1;
                const y = x1;

                return [gcd, x, y];
            }

            // T√≠nh ngh·ªãch ƒë·∫£o modular
            nghichDaoModular(e, phi) {
                const [gcd, x] = this.euclideanMoRong(e, phi);
                if (gcd !== 1) return null;
                return ((x % phi) + phi) % phi;
            }

            // L≈©y th·ª´a modular
            luyThuaModular(base, exp, mod) {
                let result = 1;
                base = base % mod;

                while (exp > 0) {
                    if (exp % 2 === 1) {
                        result = (result * base) % mod;
                    }
                    exp = Math.floor(exp / 2);
                    base = (base * base) % mod;
                }

                return result;
            }

            // T·∫°o c·∫∑p kh√≥a RSA
            taoCapKhoa(soBit = 1024, hamCapNhatTienTrinh = null) {
                console.log(`üîß B·∫Øt ƒë·∫ßu t·∫°o kh√≥a RSA v·ªõi ${soBit} bits...`);
                const thoiGianBatDau = performance.now();

                if (hamCapNhatTienTrinh) hamCapNhatTienTrinh(10);

                // T·∫°o hai s·ªë nguy√™n t·ªë p v√† q
                const p = this.taoSoNguyenTo(50, 150);
                console.log(`‚úÖ p = ${p}`);

                if (hamCapNhatTienTrinh) hamCapNhatTienTrinh(40);

                let q = this.taoSoNguyenTo(50, 150);
                while (q === p) {
                    q = this.taoSoNguyenTo(50, 150);
                }
                console.log(`‚úÖ q = ${q}`);

                if (hamCapNhatTienTrinh) hamCapNhatTienTrinh(60);

                // T√≠nh n v√† œÜ(n)
                const n = p * q;
                const phi = (p - 1) * (q - 1);
                console.log(`‚úÖ n = ${n}, œÜ(n) = ${phi}`);

                if (hamCapNhatTienTrinh) hamCapNhatTienTrinh(80);

                // Ch·ªçn e
                let e = 3;
                while (this.ucln(e, phi) !== 1 && e < phi) {
                    e += 2;
                }
                console.log(`‚úÖ e = ${e}`);

                // T√≠nh d
                const d = this.nghichDaoModular(e, phi);
                if (!d) {
                    throw new Error('Kh√¥ng th·ªÉ t√≠nh kh√≥a b√≠ m·∫≠t');
                }
                console.log(`‚úÖ d = ${d}`);

                if (hamCapNhatTienTrinh) hamCapNhatTienTrinh(100);

                // L∆ØU KH√ìA V√ÄO INSTANCE
                this.khoaCongKhai = {
                    n,
                    e
                };
                this.khoaBiMat = {
                    n,
                    d
                };

                const thoiGianKetThuc = performance.now();
                this.thongKeHieuSuat.thoiGianTaoKhoa = Math.round(thoiGianKetThuc - thoiGianBatDau);

                console.log(`üéâ T·∫°o kh√≥a th√†nh c√¥ng!`, {
                    congKhai: this.khoaCongKhai,
                    biMat: this.khoaBiMat
                });

                return {
                    congKhai: this.khoaCongKhai,
                    biMat: this.khoaBiMat,
                    soNguyenTo: {
                        p,
                        q
                    },
                    phi: phi
                };
            }

            // M√£ h√≥a tin nh·∫Øn
            maHoa(tinNhan, khoaCongKhai = null, dinhDangXuat = 'thapPhan') {
                // S·ª¨ D·ª§NG KH√ìA T·ª™ INSTANCE N·∫æU KH√îNG TRUY·ªÄN V√ÄO
                const khoa = khoaCongKhai || this.khoaCongKhai;

                if (!khoa) {
                    throw new Error('Ch∆∞a c√≥ kh√≥a c√¥ng khai! Vui l√≤ng t·∫°o kh√≥a tr∆∞·ªõc.');
                }

                console.log('üîê B·∫Øt ƒë·∫ßu m√£ h√≥a v·ªõi kh√≥a:', khoa);

                const thoiGianBatDau = performance.now();
                const {
                    n,
                    e
                } = khoa;
                const duLieuMaHoa = [];

                for (let i = 0; i < tinNhan.length; i++) {
                    const maKyTu = tinNhan.charCodeAt(i);
                    if (maKyTu >= n) {
                        throw new Error(`K√Ω t·ª± '${tinNhan[i]}' (m√£: ${maKyTu}) qu√° l·ªõn cho kh√≥a hi·ªán t·∫°i (n=${n}). Vui l√≤ng t·∫°o kh√≥a l·ªõn h∆°n.`);
                    }

                    const kyTuMaHoa = this.luyThuaModular(maKyTu, e, n);
                    duLieuMaHoa.push(kyTuMaHoa);
                }

                const thoiGianKetThuc = performance.now();
                this.thongKeHieuSuat.thoiGianMaHoa = Math.round(thoiGianKetThuc - thoiGianBatDau);

                const ketQua = dinhDangXuat === 'hex' ?
                    duLieuMaHoa.map(so => so.toString(16)).join(':') :
                    duLieuMaHoa.join(',');

                console.log('‚úÖ M√£ h√≥a th√†nh c√¥ng:', ketQua);
                return ketQua;
            }

            // Gi·∫£i m√£ tin nh·∫Øn
            giaiMa(tinNhanMaHoa, khoaBiMat = null, dinhDangNhap = 'thapPhan') {
                // S·ª¨ D·ª§NG KH√ìA T·ª™ INSTANCE N·∫æU KH√îNG TRUY·ªÄN V√ÄO
                const khoa = khoaBiMat || this.khoaBiMat;

                if (!khoa) {
                    throw new Error('Ch∆∞a c√≥ kh√≥a b√≠ m·∫≠t! Vui l√≤ng t·∫°o kh√≥a tr∆∞·ªõc.');
                }

                console.log('üîì B·∫Øt ƒë·∫ßu gi·∫£i m√£ v·ªõi kh√≥a:', khoa);

                const thoiGianBatDau = performance.now();
                const {
                    n,
                    d
                } = khoa;

                let mangMaHoa;
                try {
                    if (dinhDangNhap === 'hex') {
                        mangMaHoa = tinNhanMaHoa.split(':').map(hex => parseInt(hex, 16));
                    } else {
                        mangMaHoa = tinNhanMaHoa.split(',').map(so => parseInt(so));
                    }
                } catch (error) {
                    throw new Error('ƒê·ªãnh d·∫°ng d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá: ' + error.message);
                }

                let ketQuaGiaiMa = '';

                for (const kyTuMaHoa of mangMaHoa) {
                    if (isNaN(kyTuMaHoa)) {
                        throw new Error('D·ªØ li·ªáu ch·ª©a k√Ω t·ª± kh√¥ng h·ª£p l·ªá');
                    }
                    const kyTuGiaiMa = this.luyThuaModular(kyTuMaHoa, d, n);
                    ketQuaGiaiMa += String.fromCharCode(kyTuGiaiMa);
                }

                const thoiGianKetThuc = performance.now();
                this.thongKeHieuSuat.thoiGianGiaiMa = Math.round(thoiGianKetThuc - thoiGianBatDau);

                console.log('‚úÖ Gi·∫£i m√£ th√†nh c√¥ng:', ketQuaGiaiMa);
                return ketQuaGiaiMa;
            }

            // Ki·ªÉm tra tr·∫°ng th√°i kh√≥a
            kiemTraKhoa() {
                return {
                    coKhoaCongKhai: !!this.khoaCongKhai,
                    coKhoaBiMat: !!this.khoaBiMat,
                    khoaCongKhai: this.khoaCongKhai,
                    khoaBiMat: this.khoaBiMat
                };
            }
        }

        // Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng RSA TO√ÄN C·ª§C
        const rsa = new MaHoaRSANangCao();

        // Hi·ªáu ·ª©ng Matrix Rain
        function khoiTaoHieuUngMatrix() {
            const canvas = document.getElementById('matrixCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const kyTu = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()+-/~{[|]}";
            const mangKyTu = kyTu.split("");

            const kichThuocFont = 10;
            const soCot = canvas.width / kichThuocFont;
            const giot = [];

            for (let x = 0; x < soCot; x++) {
                giot[x] = 1;
            }

            function ve() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#00ff41';
                ctx.font = kichThuocFont + 'px Fira Code';

                for (let i = 0; i < giot.length; i++) {
                    const kyTuNgauNhien = mangKyTu[Math.floor(Math.random() * mangKyTu.length)];
                    ctx.fillText(kyTuNgauNhien, i * kichThuocFont, giot[i] * kichThuocFont);

                    if (giot[i] * kichThuocFont > canvas.height && Math.random() > 0.975) {
                        giot[i] = 0;
                    }
                    giot[i]++;
                }
            }

            setInterval(ve, 35);
        }

        // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
        function capNhatTienTrinh(phanTram) {
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = phanTram + '%';
            }
        }

        // H√†m sao ch√©p v√†o clipboard
        async function saoChep(idPhanTu) {
            const phanTu = document.getElementById(idPhanTu);
            if (!phanTu) return;

            const noiDung = phanTu.textContent;

            try {
                await navigator.clipboard.writeText(noiDung);
                capNhatTrangThai('üìã ƒê√£ sao ch√©p v√†o clipboard!');

                // Hi·ªáu ·ª©ng th·ªã gi√°c
                phanTu.style.background = 'rgba(0, 255, 65, 0.2)';
                setTimeout(() => {
                    phanTu.style.background = '#0a0a0a';
                }, 500);
            } catch (loi) {
                console.error('L·ªói sao ch√©p:', loi);
                capNhatTrangThai('‚ùå Kh√¥ng th·ªÉ sao ch√©p v√†o clipboard');
            }
        }

        // H√†m t·∫°o kh√≥a - S·ª¨A L·ªñI CH√çNH
        function taoKhoa() {
            const kichThuocKhoa = parseInt(document.getElementById('keySize').value);
            const bieuTuongTai = document.getElementById('keyGenLoading');
            const vanBanNut = document.getElementById('keyGenText');

            console.log('üöÄ B·∫Øt ƒë·∫ßu t·∫°o kh√≥a RSA...');

            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
            if (bieuTuongTai) bieuTuongTai.style.display = 'inline-block';
            if (vanBanNut) vanBanNut.textContent = 'ƒêang t·∫°o...';
            capNhatTrangThai('üîÑ ƒêang t·∫°o kh√≥a RSA...');
            capNhatTienTrinh(0);

            // M√¥ ph·ªèng qu√° tr√¨nh t·∫°o kh√≥a v·ªõi timeout ng·∫Øn h∆°n
            setTimeout(() => {
                try {
                    const cacKhoa = rsa.taoCapKhoa(kichThuocKhoa, capNhatTienTrinh);

                    // Ki·ªÉm tra kh√≥a ƒë√£ ƒë∆∞·ª£c t·∫°o
                    const trangThaiKhoa = rsa.kiemTraKhoa();
                    console.log('Tr·∫°ng th√°i kh√≥a sau khi t·∫°o:', trangThaiKhoa);

                    // Hi·ªÉn th·ªã kh√≥a
                    const publicKeyElement = document.getElementById('publicKey');
                    const privateKeyElement = document.getElementById('privateKey');

                    if (publicKeyElement) {
                        publicKeyElement.innerHTML =
                            `<strong>n:</strong> ${cacKhoa.congKhai.n.toLocaleString()}<br><strong>e:</strong> ${cacKhoa.congKhai.e}`;
                    }

                    if (privateKeyElement) {
                        privateKeyElement.innerHTML =
                            `<strong>n:</strong> ${cacKhoa.biMat.n.toLocaleString()}<br><strong>d:</strong> ${cacKhoa.biMat.d.toLocaleString()}`;
                    }

                    // C·∫≠p nh·∫≠t th·ªëng k√™ hi·ªáu su·∫•t
                    const keyGenTimeElement = document.getElementById('keyGenTime');
                    if (keyGenTimeElement) {
                        keyGenTimeElement.textContent = rsa.thongKeHieuSuat.thoiGianTaoKhoa;
                    }

                    capNhatTrangThai(`‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng kh√≥a RSA (n=${cacKhoa.congKhai.n})!`);
                    capNhatTienTrinh(100);

                    // Reset UI sau khi ho√†n t·∫•t
                    setTimeout(() => {
                        if (bieuTuongTai) bieuTuongTai.style.display = 'none';
                        if (vanBanNut) vanBanNut.textContent = 'T·∫°o Kh√≥a RSA';
                        capNhatTienTrinh(0);
                    }, 1000);

                } catch (loi) {
                    console.error('L·ªói t·∫°o kh√≥a:', loi);
                    capNhatTrangThai('‚ùå L·ªói khi t·∫°o kh√≥a: ' + loi.message);

                    if (bieuTuongTai) bieuTuongTai.style.display = 'none';
                    if (vanBanNut) vanBanNut.textContent = 'T·∫°o Kh√≥a RSA';
                    capNhatTienTrinh(0);
                }
            }, 100); // Gi·∫£m timeout xu·ªëng 100ms
        }

        // H√†m m√£ h√≥a tin nh·∫Øn - S·ª¨A L·ªñI
        function maHoaTinNhan() {
            const vanBanGoc = document.getElementById('plaintext').value;
            const xuatHex = document.getElementById('hexOutput').checked;
            const bieuTuongTai = document.getElementById('encryptLoading');
            const vanBanNut = document.getElementById('encryptText');

            console.log('üîê B·∫Øt ƒë·∫ßu m√£ h√≥a tin nh·∫Øn:', vanBanGoc);

            if (!vanBanGoc.trim()) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p tin nh·∫Øn c·∫ßn m√£ h√≥a');
                return;
            }

            // KI·ªÇM TRA KH√ìA TR∆Ø·ªöC KHI M√É H√ìA
            const trangThaiKhoa = rsa.kiemTraKhoa();
            console.log('Tr·∫°ng th√°i kh√≥a tr∆∞·ªõc m√£ h√≥a:', trangThaiKhoa);

            if (!trangThaiKhoa.coKhoaCongKhai) {
                alert('‚ö†Ô∏è Vui l√≤ng t·∫°o kh√≥a tr∆∞·ªõc khi m√£ h√≥a');
                return;
            }

            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
            if (bieuTuongTai) bieuTuongTai.style.display = 'inline-block';
            if (vanBanNut) vanBanNut.textContent = 'ƒêang m√£ h√≥a...';
            capNhatTrangThai('üîí ƒêang m√£ h√≥a tin nh·∫Øn...');

            setTimeout(() => {
                try {
                    const dinhDangXuat = xuatHex ? 'hex' : 'thapPhan';
                    const duLieuMaHoa = rsa.maHoa(vanBanGoc, null, dinhDangXuat);

                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    const encryptedOutputElement = document.getElementById('encryptedOutput');
                    const ciphertextElement = document.getElementById('ciphertext');

                    if (encryptedOutputElement) {
                        encryptedOutputElement.textContent = duLieuMaHoa;
                    }
                    if (ciphertextElement) {
                        ciphertextElement.value = duLieuMaHoa;
                    }

                    // C·∫≠p nh·∫≠t th·ªëng k√™ hi·ªáu su·∫•t
                    const encryptTimeElement = document.getElementById('encryptTime');
                    if (encryptTimeElement) {
                        encryptTimeElement.textContent = rsa.thongKeHieuSuat.thoiGianMaHoa;
                    }

                    capNhatTrangThai(`‚úÖ M√£ h√≥a th√†nh c√¥ng! (${vanBanGoc.length} k√Ω t·ª± ‚Üí ${duLieuMaHoa.length} k√Ω t·ª±)`);

                    // Reset UI
                    if (bieuTuongTai) bieuTuongTai.style.display = 'none';
                    if (vanBanNut) vanBanNut.innerHTML = 'üîê M√£ H√≥a Tin Nh·∫Øn';

                } catch (loi) {
                    console.error('L·ªói m√£ h√≥a:', loi);
                    capNhatTrangThai('‚ùå L·ªói m√£ h√≥a: ' + loi.message);

                    if (bieuTuongTai) bieuTuongTai.style.display = 'none';
                    if (vanBanNut) vanBanNut.innerHTML = 'üîê M√£ H√≥a Tin Nh·∫Øn';
                }
            }, 100);
        }

        // H√†m gi·∫£i m√£ tin nh·∫Øn - S·ª¨A L·ªñI
        function giaiMaTinNhan() {
            const duLieuMaHoa = document.getElementById('ciphertext').value;
            const nhapHex = document.getElementById('hexInput').checked;
            const bieuTuongTai = document.getElementById('decryptLoading');
            const vanBanNut = document.getElementById('decryptText');

            console.log('üîì B·∫Øt ƒë·∫ßu gi·∫£i m√£ tin nh·∫Øn:', duLieuMaHoa);

            if (!duLieuMaHoa.trim()) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p d·ªØ li·ªáu ƒë√£ m√£ h√≥a');
                return;
            }

            // KI·ªÇM TRA KH√ìA TR∆Ø·ªöC KHI GI·∫¢I M√É
            const trangThaiKhoa = rsa.kiemTraKhoa();
            console.log('Tr·∫°ng th√°i kh√≥a tr∆∞·ªõc gi·∫£i m√£:', trangThaiKhoa);

            if (!trangThaiKhoa.coKhoaBiMat) {
                alert('‚ö†Ô∏è Vui l√≤ng t·∫°o kh√≥a tr∆∞·ªõc khi gi·∫£i m√£');
                return;
            }

            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
            if (bieuTuongTai) bieuTuongTai.style.display = 'inline-block';
            if (vanBanNut) vanBanNut.textContent = 'ƒêang gi·∫£i m√£...';
            capNhatTrangThai('üîì ƒêang gi·∫£i m√£ tin nh·∫Øn...');

            setTimeout(() => {
                try {
                    const dinhDangNhap = nhapHex ? 'hex' : 'thapPhan';
                    const duLieuGiaiMa = rsa.giaiMa(duLieuMaHoa, null, dinhDangNhap);

                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    const decryptedOutputElement = document.getElementById('decryptedOutput');
                    if (decryptedOutputElement) {
                        decryptedOutputElement.textContent = duLieuGiaiMa;
                    }

                    // C·∫≠p nh·∫≠t th·ªëng k√™ hi·ªáu su·∫•t
                    const decryptTimeElement = document.getElementById('decryptTime');
                    if (decryptTimeElement) {
                        decryptTimeElement.textContent = rsa.thongKeHieuSuat.thoiGianGiaiMa;
                    }

                    capNhatTrangThai(`‚úÖ Gi·∫£i m√£ th√†nh c√¥ng! (Kh√¥i ph·ª•c ${duLieuGiaiMa.length} k√Ω t·ª±)`);

                    // Reset UI
                    if (bieuTuongTai) bieuTuongTai.style.display = 'none';
                    if (vanBanNut) vanBanNut.innerHTML = 'üîì Gi·∫£i M√£ Tin Nh·∫Øn';

                } catch (loi) {
                    console.error('L·ªói gi·∫£i m√£:', loi);
                    capNhatTrangThai('‚ùå L·ªói gi·∫£i m√£: ' + loi.message);

                    if (bieuTuongTai) bieuTuongTai.style.display = 'none';
                    if (vanBanNut) vanBanNut.innerHTML = 'üîì Gi·∫£i M√£ Tin Nh·∫Øn';
                }
            }, 100);
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i
        function capNhatTrangThai(thongBao) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = thongBao;
            }
            console.log('Status:', thongBao);
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = function() {
            console.log('üéØ Kh·ªüi t·∫°o h·ªá th·ªëng RSA...');

            khoiTaoHieuUngMatrix();
            capNhatTrangThai('üöÄ H·ªá Th·ªëng M√£ H√≥a RSA S·∫µn S√†ng');

            // T·ª± ƒë·ªông thay ƒë·ªïi k√≠ch th∆∞·ªõc canvas
            window.addEventListener('resize', () => {
                const canvas = document.getElementById('matrixCanvas');
                if (canvas) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
            });

            // Debug mode
            console.log('üîß Debug mode enabled');
            console.log('RSA instance:', rsa);
        };

        // Hi·ªáu ·ª©ng nh·∫•p nh√°y con tr·ªè
        setInterval(() => {
            const conTro = document.querySelector('.cursor');
            if (conTro) {
                conTro.style.opacity = conTro.style.opacity === '0' ? '1' : '0';
            }
        }, 500);

        // Debug function ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i
        window.debugRSA = function() {
            console.log('=== DEBUG RSA ===');
            console.log('RSA Instance:', rsa);
            console.log('Tr·∫°ng th√°i kh√≥a:', rsa.kiemTraKhoa());
            console.log('================');
        };
    </script>
</body>

</html>